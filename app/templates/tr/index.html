{% extends "layout/base.html" %}
{% block content %}

<style>
  /* ç®€å•çš„ 3 è¡Œæˆªæ–­ï¼šä¸ç”¨ Tailwind line-clamp æ’ä»¶ä¹Ÿèƒ½å·¥ä½œ */
  .clamp-3{
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<div class="grid grid-cols-12 gap-6">
  <div class="col-span-12 lg:col-span-12">
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">

      <!-- é¡¶éƒ¨ï¼šæœç´¢ + ç»Ÿè®¡ + æ–°å¢æŒ‰é’® -->
      <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-4">
        <form method="get" class="flex-1">
          <div class="relative">
            <input
              type="text"
              name="q"
              value="{{ q or '' }}"
              placeholder="æœç´¢ TR No. / Supplier / PN / Issue..."
              class="w-full rounded-xl border border-slate-200 bg-white px-4 py-2.5
                     text-sm text-slate-800 placeholder:text-slate-400
                     focus:outline-none focus:ring-2 focus:ring-slate-300"
            />
            {% if q %}
              <a href="{{ url_for('tr.index', per_page=per_page) }}"
                 class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 text-sm">
                æ¸…é™¤
              </a>
            {% endif %}
          </div>
        </form>

        <div class="flex items-center gap-3 shrink-0">
          <div class="text-sm text-slate-500">
            å…± {{ pagination.total }} æ¡ï¼ˆç¬¬ {{ pagination.page }}/{{ pagination.pages if pagination.pages else 1 }} é¡µï¼‰
          </div>

          <a href="{{ url_for('tr.new_tr') }}"
             class="group inline-flex items-center justify-center w-9 h-9 rounded-lg
                    bg-slate-200 text-slate-700 hover:bg-slate-300 hover:text-slate-900
                    border border-slate-300 shadow-sm transition active:scale-[0.96] active:shadow-inner"
             title="æ–°å¢ TR" aria-label="æ–°å¢ TR">
            <svg viewBox="0 0 24 24" class="w-5 h-5 transition-transform group-active:scale-95" fill="none" aria-hidden="true">
              <path d="M12 5v14M5 12h14"
                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </a>
        </div>
      </div>

      {# ========= é¢œè‰²/ç¯å·æ˜ å°„ï¼šçº¯æ¨¡æ¿å†…å®Œæˆï¼Œä¸ä¾èµ–åç«¯æ”¹å­—æ®µ ========= #}
      {% macro dot(color_class, title_text) -%}
        <span class="inline-block w-3 h-3 rounded-full {{ color_class }}"
              title="{{ title_text }}"
              aria-label="{{ title_text }}"></span>
      {%- endmacro %}

      <div>
        <table class="w-full table-fixed text-sm">
          <thead class="bg-slate-50">
            <tr class="text-xs font-medium text-slate-500 uppercase tracking-wide">
              <th class="w-[110px] px-2 py-2 text-left">TR No.</th>
              <th class="w-[14%]  px-2 py-2 text-left">Supplier</th>
              <th class="w-[18%]  px-2 py-2 text-left">Part No.</th>
              <th class="w-[14%]  px-2 py-2 text-left">Part Name</th>

              {# ISSUE ç»™æ›´å¤šç©ºé—´ #}
              <th class="w-[32%]  px-2 py-2 text-center">Issue</th>

              <th class="w-[54px]  px-1 py-2 text-center">Sev</th>

              {# 8D / ST ç”¨ç¯å·ï¼šåˆ—å®½æçª„ #}
              <th class="w-[46px]  px-1 py-2 text-center">8D</th>
              <th class="w-[46px]  px-1 py-2 text-center">ST</th>

              <th class="w-[16%]  px-2 py-2 text-center">NOTE</th>
              <th class="w-[90px]  px-2 py-2 text-center normal-case">Action</th>
            </tr>
          </thead>

          <tbody class="divide-y divide-slate-100">
            {% for tr in trs %}

              {# --- ç»Ÿä¸€çŠ¶æ€å°å†™æ–¹ä¾¿åˆ¤æ–­ --- #}
              {% set status = (tr.status or '')|lower %}
              {% set eightd = (tr.eight_d or '')|lower %}

              {# --- è¡Œé«˜äº®ï¼šOverdue / Late è½»å¾®çº¢åº•ï¼Œæ–¹ä¾¿æ‰«è¡¨ --- #}
              {% set row_cls = "hover:bg-slate-50/60 align-top" %}
              {% if status in ['overdue', 'late'] %}
                {% set row_cls = row_cls ~ " bg-rose-50/40" %}
              {% endif %}

              <tr class="{{ row_cls }}">

                <!-- TR NO.ï¼šç­‰å®½ + ä¸æ¢è¡Œï¼ˆæ›´åƒç³»ç»Ÿç¼–å·ï¼‰ -->
                <td class="px-2 py-3 font-medium text-slate-900 whitespace-nowrap font-mono">
                  <div title="{{ tr.tr_no }}">{{ tr.tr_no }}</div>
                </td>

                <td class="px-2 py-3 text-slate-700">
                  <div class="truncate" title="{{ tr.supplier_name }}">{{ tr.supplier_name }}</div>
                </td>

                <!-- Part No.ï¼šå®Œæ•´æ˜¾ç¤º + ç­‰å®½ + ä¸æ¢è¡Œ -->
                <td class="px-2 py-3 text-slate-800 whitespace-nowrap font-mono">
                  <div title="{{ tr.part_number or '' }}">{{ tr.part_number or "-" }}</div>
                </td>

                <!-- Part Nameï¼šå¯ä»¥é€‚åº¦æˆªæ–­ -->
                <td class="px-2 py-3 text-slate-700">
                  <div class="truncate" title="{{ tr.part_name or '' }}">{{ tr.part_name or "-" }}</div>
                </td>

                <!-- Issueï¼š3 è¡Œæˆªæ–­ + tooltip -->
                <td class="px-2 py-3 text-slate-600">
                  <div class="text-[13px] leading-5 clamp-3" title="{{ tr.issue_description or '' }}">
                    {{ tr.issue_description }}
                  </div>
                </td>


                <!-- Sevï¼šå° badgeï¼ˆç´§å‡‘ï¼‰ -->
                <td class="px-1 py-3 text-center">
                  {% if tr.severity %}
                    <span class="inline-flex items-center justify-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-700">
                      {{ tr.severity }}
                    </span>
                  {% else %}
                    <span class="text-slate-400">-</span>
                  {% endif %}
                </td>

                <!-- 8Dï¼šç¯å·ï¼ˆhover çœ‹å«ä¹‰ï¼‰ -->
                <td class="px-1 py-3 text-center">
                  {% set d8 = (tr.eight_d_status or 'NOT_REQUIRED')|trim|upper %}

                  {% if d8 == 'NOT_REQUIRED' %}
                    <span class="inline-block w-3 h-3 rounded-full bg-slate-300 shadow-[inset_0_1px_1px_rgba(255,255,255,.6),0_2px_4px_rgba(0,0,0,.2)]"
                          title="8D: Not required"></span>

                  {% elif d8 == 'NOT_RECEIVED' %}
                    <span class="inline-block w-3 h-3 rounded-full bg-yellow-400 shadow-[0_0_8px_rgba(250,204,21,.8),0_2px_4px_rgba(0,0,0,.25)]"
                          title="8D: Required but not received"></span>

                  {% elif d8 == 'RECEIVED_REJECT' %}
                    <span class="inline-block w-3 h-3 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,.9),0_2px_4px_rgba(0,0,0,.28)]"
                          title="8D: Received (Reject)"></span>

                  {% elif d8 == 'RECEIVED_PASS' %}
                    <span class="inline-block w-3 h-3 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(34,197,94,.9),0_2px_4px_rgba(0,0,0,.28)]"
                          title="8D: Received (Pass)"></span>

                  {% else %}
                    <span class="inline-block w-3 h-3 rounded-full bg-slate-300 shadow-[inset_0_1px_1px_rgba(255,255,255,.6),0_2px_4px_rgba(0,0,0,.2)]"
                          title="8D: Unknown ({{ tr.eight_d_status }})"></span>
                  {% endif %}
                </td>





                <!-- Statusï¼šäº¤é€šç¯ -->
                <td class="px-1 py-3 text-center">
                  {% set st = (tr.status or '')|lower %}
                  {% if st in ['overdue','late'] %}
                    <span class="inline-flex items-center justify-center h-5 px-2 rounded-full text-[11px] font-semibold
                                 bg-red-100 text-red-700 shadow-[inset_0_1px_0_rgba(255,255,255,.7),0_2px_4px_rgba(0,0,0,.18)]"
                          title="Overdue">LATE</span>
                  {% elif st in ['closed','done','complete','completed'] %}
                    <span class="inline-flex items-center justify-center h-5 px-2 rounded-full text-[11px] font-semibold
                                 bg-emerald-100 text-emerald-700 shadow-[inset_0_1px_0_rgba(255,255,255,.7),0_2px_4px_rgba(0,0,0,.18)]"
                          title="Closed">OK</span>
                  {% else %}
                    <span class="inline-flex items-center justify-center h-5 px-2 rounded-full text-[11px] font-semibold
                                 bg-yellow-100 text-yellow-800 shadow-[inset_0_1px_0_rgba(255,255,255,.7),0_2px_4px_rgba(0,0,0,.18)]"
                          title="Ongoing">ON</span>
                  {% endif %}
                </td>



                <!-- Remarkï¼šæˆªæ–­ + tooltip -->
                <td class="px-8 py-3 text-slate-700">
                  <div class="truncate" title="{{ tr.remark or '' }}">{{ tr.remark or "-" }}</div>
                </td>

                <!-- Actionï¼šæ›´ç´§å‡‘ -->
                <td class="px-2 py-3 text-right">
                  <div class="flex flex-col items-end gap-1 text-sm">
                    <!-- Edit -->
                    <a href="{{ url_for('tr.edit_tr', tr_id=tr.id) }}"
                       class="text-blue-600 hover:text-blue-800"
                       title="Edit">
                      âœ
                    </a>

                    <!-- Delete -->
                    <form method="post"
                          action="{{ url_for('tr.delete_tr', tr_id=tr.id) }}"
                          onsubmit="return confirm('ç¡®è®¤åˆ é™¤ TR {{ tr.tr_no }} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚');">
                      <button type="submit"
                              class="text-rose-600 hover:text-rose-800"
                              title="Delete">
                        ğŸ—‘
                      </button>
                    </form>
                  </div>
                </td>

              </tr>
            {% endfor %}

            {% if trs|length == 0 %}
            <tr>
              <td colspan="10" class="px-5 py-10 text-center text-slate-400">æš‚æ— æ•°æ®</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      {% if pagination.pages > 1 %}
      <div class="px-5 py-4 border-t border-slate-100 flex items-center justify-between">
        <div class="text-sm text-slate-500">
          {% if pagination.total > 0 %}
            æ˜¾ç¤ºç¬¬
            {{ (pagination.page - 1) * pagination.per_page + 1 }}
            -
            {{ (pagination.page - 1) * pagination.per_page + trs|length }}
            æ¡
          {% else %}
            æ— ç»“æœ
          {% endif %}
        </div>

        <nav class="flex items-center gap-2">
          {% if pagination.has_prev %}
            <a class="px-3 py-1.5 rounded-lg border text-sm hover:bg-slate-50"
               href="{{ url_for('tr.index', page=pagination.prev_num, q=q, per_page=per_page) }}">ä¸Šä¸€é¡µ</a>
          {% else %}
            <span class="px-3 py-1.5 rounded-lg border text-sm text-slate-400 bg-slate-50">ä¸Šä¸€é¡µ</span>
          {% endif %}

          <div class="flex items-center gap-1">
            {% for p in range(1, pagination.pages + 1) %}
              {% if p == pagination.page %}
                <span class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm">{{ p }}</span>
              {% else %}
                <a class="px-3 py-1.5 rounded-lg border text-sm hover:bg-slate-50"
                   href="{{ url_for('tr.index', page=p, q=q, per_page=per_page) }}">{{ p }}</a>
              {% endif %}
            {% endfor %}
          </div>

          {% if pagination.has_next %}
            <a class="px-3 py-1.5 rounded-lg border text-sm hover:bg-slate-50"
               href="{{ url_for('tr.index', page=pagination.next_num, q=q, per_page=per_page) }}">ä¸‹ä¸€é¡µ</a>
          {% else %}
            <span class="px-3 py-1.5 rounded-lg border text-sm text-slate-400 bg-slate-50">ä¸‹ä¸€é¡µ</span>
          {% endif %}
        </nav>
      </div>
      {% endif %}

    </div>
  </div>
</div>

{% endblock %}
