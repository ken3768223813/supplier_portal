{% extends "layout/base.html" %}
{% block content %}

<div class="max-w-7xl mx-auto px-6 py-6">

  <!-- Header -->
  <div class="bg-white rounded-2xl border-2 border-gray-200 overflow-hidden mb-6">
    <div class="px-6 py-5 border-b-2 border-gray-100 flex items-start justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Business Trips</h1>
        <p class="text-sm text-gray-500 mt-1">SQE Supplier Audit Management (planning / ongoing / completed)</p>
      </div>

      <div class="flex items-center gap-3">
        <form method="get" class="relative">
          <input
            name="q"
            value="{{ q or '' }}"
            placeholder="Search trip no / supplier / engineer / purpose..."
            class="w-[360px] max-w-full rounded-xl border-2 border-gray-200 px-4 py-2.5 text-sm
                   focus:outline-none focus:border-gray-900 placeholder:text-gray-400"
          />
        </form>

        <a href="{{ url_for('trip.new_trip') }}"
           class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-gray-900 text-white font-bold
                  hover:bg-gray-800 transition-all hover:scale-105 active:scale-95">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
          </svg>
          New Trip
        </a>
      </div>
    </div>

    <!-- Stats -->
    <div class="px-6 py-4 grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-50 border-b-2 border-gray-100">
      <div class="rounded-xl border-2 border-gray-200 bg-white p-4">
        <div class="text-xs text-gray-500 font-semibold">Total</div>
        <div class="text-2xl font-bold text-gray-900 mt-1">{{ stats.total }}</div>
      </div>
      <div class="rounded-xl border-2 border-gray-200 bg-white p-4">
        <div class="text-xs text-gray-500 font-semibold">Planning</div>
        <div class="text-2xl font-bold text-amber-600 mt-1">{{ stats.planning }}</div>
      </div>
      <div class="rounded-xl border-2 border-gray-200 bg-white p-4">
        <div class="text-xs text-gray-500 font-semibold">Ongoing</div>
        <div class="text-2xl font-bold text-blue-600 mt-1">{{ stats.ongoing }}</div>
      </div>
      <div class="rounded-xl border-2 border-gray-200 bg-white p-4">
        <div class="text-xs text-gray-500 font-semibold">Completed</div>
        <div class="text-2xl font-bold text-emerald-600 mt-1">{{ stats.completed }}</div>
      </div>
    </div>
  </div>

  {% if supplier_groups %}
    <div class="space-y-6">
      {% for k, g in supplier_groups.items() %}
        <div class="bg-white rounded-2xl border-2 border-gray-200 overflow-hidden">
          <div class="px-6 py-4 border-b-2 border-gray-100 flex items-center justify-between gap-4">
            <div class="min-w-0">
              <div class="flex items-center gap-3">
                <div class="px-3 py-1.5 rounded-xl border-2 border-gray-200 bg-gray-50 font-mono text-xs font-bold text-gray-700">
                  {{ g.code or "N/A" }}
                </div>
                <div class="font-bold text-gray-900 text-lg truncate">{{ g.name }}</div>
              </div>
              {% if g.location %}
                <div class="text-xs text-gray-500 mt-1 truncate">ğŸ“ {{ g.location }}</div>
              {% endif %}
            </div>

            <div class="flex items-center gap-3">
              <div class="rounded-xl border-2 border-gray-200 bg-gray-50 px-3 py-2 text-center">
                <div class="text-[11px] text-gray-500 font-semibold">Trips</div>
                <div class="text-lg font-bold text-gray-900">{{ g.total_trips }}</div>
              </div>
              <div class="rounded-xl border-2 border-gray-200 bg-gray-50 px-3 py-2 text-center">
                <div class="text-[11px] text-gray-500 font-semibold">Docs</div>
                <div class="text-lg font-bold text-indigo-600">{{ g.total_docs }}</div>
              </div>
            </div>
          </div>

          <!-- Trips table -->
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50 border-b-2 border-gray-100">
                <tr class="text-left text-xs font-bold text-gray-600">
                  <th class="px-6 py-3">Trip No.</th>
                  <th class="px-6 py-3">Engineer</th>
                  <th class="px-6 py-3">Audit Type</th>
                  <th class="px-6 py-3">Date</th>
                  <th class="px-6 py-3">Status</th>
                  <th class="px-6 py-3 text-right">Docs</th>
                  <th class="px-6 py-3 text-right">Action</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                {% for trip in g.trips %}
                  <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 font-mono font-bold text-gray-900">{{ trip.trip_no }}</td>
                    <td class="px-6 py-4 text-gray-700 font-semibold">{{ trip.engineer }}</td>
                    <td class="px-6 py-4 text-gray-700">
                      {{ audit_types.get(trip.audit_type, trip.audit_type or '-') }}
                    </td>
                    <td class="px-6 py-4 text-gray-700">
                      <span class="font-semibold">{{ trip.start_date.strftime('%Y-%m-%d') }}</span>
                      <span class="text-gray-400 mx-1">â†’</span>
                      <span class="font-semibold">{{ trip.end_date.strftime('%Y-%m-%d') }}</span>
                      <span class="text-xs text-gray-500 ml-2">({{ trip.days }}d)</span>
                    </td>
                    <td class="px-6 py-4">
                      {% set st = trip.status or 'planning' %}
                      <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold border-2
                        {% if st == 'planning' %}bg-amber-50 text-amber-700 border-amber-200
                        {% elif st == 'ongoing' %}bg-blue-50 text-blue-700 border-blue-200
                        {% else %}bg-emerald-50 text-emerald-700 border-emerald-200{% endif %}">
                        {{ trip_status.get(st, st) }}
                      </span>
                    </td>
                    <td class="px-4 py-4 text-center">
                      {% set doc_count = trip.documents.count() %}
                      <button
                        type="button"
                        onclick="openTripDocumentsModal({{ trip.id }})"
                        class="inline-flex items-center justify-center min-w-[2.5rem] px-3 py-1.5 rounded-xl
                               border-2 border-indigo-200 bg-indigo-50 text-indigo-700 font-bold
                               hover:bg-indigo-100 hover:border-indigo-400 transition-all"
                        title="Open documents"
                      >
                        {{ doc_count }}
                      </button>
                    </td>

                    <td class="px-6 py-4 text-right">
                      <div class="inline-flex items-center gap-2">
                        <a href="{{ url_for('trip.edit_trip', trip_id=trip.id) }}"
                           class="inline-flex items-center gap-1.5 px-3 py-2 rounded-lg
                                  bg-blue-50 text-blue-700 border-2 border-blue-200
                                  hover:bg-blue-100 hover:border-blue-400 transition-all text-xs font-bold">
                          Edit
                        </a>
                        <form method="post"
                              action="{{ url_for('trip.delete_trip', trip_id=trip.id) }}"
                              onsubmit="return confirm('Delete trip {{ trip.trip_no }}?');"
                              class="inline">
                          <button type="submit"
                                  class="inline-flex items-center gap-1.5 px-3 py-2 rounded-lg
                                         bg-red-50 text-red-700 border-2 border-red-200
                                         hover:bg-red-100 hover:border-red-400 transition-all text-xs font-bold">
                            Delete
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="bg-white rounded-2xl border-2 border-dashed border-gray-200 p-10 text-center">
      <p class="text-lg font-bold text-gray-900">No trips found</p>
      <p class="text-sm text-gray-500 mt-2">Create your first trip to start tracking supplier audits.</p>
      <a href="{{ url_for('trip.new_trip') }}"
         class="mt-5 inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-gray-900 text-white font-bold
                hover:bg-gray-800 transition-all hover:scale-105 active:scale-95">
        + New Trip
      </a>
    </div>
  {% endif %}

</div>

<!-- Modal container (append fetched HTML here) -->
<div id="trip-documents-modal-container"></div>

<script>
  function openTripDocumentsModal(tripId) {
    // å¦‚æœå·²å­˜åœ¨æ—§ modalï¼Œå…ˆåˆ æ‰
    const container = document.getElementById('trip-documents-modal-container');
    if (!container) return;
    container.innerHTML = '';

    const urlTemplate = "{{ url_for('trip.documents_panel', trip_id=0) }}";
    const url = urlTemplate.replace('/0/', '/' + tripId + '/');

    // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
    document.body.style.overflow = 'hidden';

    fetch(url, { headers: { 'X-Requested-With': 'fetch' } })
      .then(r => {
        if (!r.ok) throw new Error('Failed to load documents panel');
        return r.text();
      })
      .then(html => {
        container.innerHTML = html;
      })
      .catch(err => {
        console.error(err);
        document.body.style.overflow = '';
        alert('Failed to open documents.');
      });
  }

  // ä¾› panel å†…éƒ¨è°ƒç”¨ï¼ˆä½ å·²ç»åœ¨ panel é‡Œå†™äº† closeTripDocumentsModalï¼‰
  // è¿™é‡Œä¸ç”¨é‡å¤å†™ closeï¼Œåªè¦ panel æœ‰å°±è¡Œ


    (function () {
      function closeTripDocs() {
        // ä½ å¼¹çª—çš„æœ€å¤–å±‚å°±æ˜¯è¿™ä¸ª id
        const overlay = document.getElementById('trip-documents-overlay');
        if (!overlay) return;

        overlay.style.opacity = '0';
        setTimeout(() => {
          overlay.remove();
          document.body.style.overflow = '';
        }, 120);
      }

      // äº‹ä»¶å§”æ‰˜ï¼šä¸ç”¨ onclickï¼Œæ³¨å…¥çš„ HTML ä¸€æ ·èƒ½å“åº”
      document.addEventListener('click', function (e) {
        // ç‚¹ X å…³é—­
        if (e.target.closest('[data-trip-docs-close]')) {
          e.preventDefault();
          closeTripDocs();
          return;
        }

        // ç‚¹é®ç½©å…³é—­ï¼ˆåªæœ‰ç‚¹åˆ°é®ç½©æœ¬èº«æ‰å…³ï¼‰
        const overlay = e.target.closest('[data-trip-docs-overlay]');
        if (overlay && e.target === overlay) {
          closeTripDocs();
          return;
        }
      });

      // ESC å…³é—­
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') closeTripDocs();
      });

      // å¦‚æœä½ ä»æƒ³ä¿ç•™æ—§çš„ onclick å†™æ³•ï¼Œä¹Ÿç»™ä¸€ä¸ªå…¨å±€å‡½æ•°ï¼ˆå¯é€‰ï¼‰
      window.closeTripDocumentsModal = function () { closeTripDocs(); };
    })();

</script>


{% endblock %}
